<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>第十六章、例行性工作排程<span class="text_head_en"> (crontab)</title><link href="../Styles/style.css" rel="stylesheet" type="text/css" /></head><body>

<!-- 本文的档头部分 -->
<div style="text-align: center;">
    <a href="0430cron.php.html">
    <span class="text_head0">第十六章、例行性工作排程<span class="text_head_en"> (crontab)</span></span></a><br>
</div>
    <div style="text-align: right;">
        <span class="text_history">最近升级日期：2009/09/11</span>
    </div>
<!-- 本文的连结区部分 -->
<div class="block1">
<span class="text_h1">
4. <a href="#anacron_1">可唤醒停机期间的工作任务</a><br>
	<span class="text_h2">
	　　4.1 <a href="#anacron_what">什么是 anacron</a><br>
	　　4.2 <a href="#anacron">anacron 与 /etc/anacrontab</a><br>
	</span>
</span></div>
<!-- 本文的正式部分 -->
<hr><a name="anacron_1"></a><img src="../images/logo.png" alt="大标题的图示" width="35" align="middle" height="34"><span class="text_h1">可唤醒停机期间的工作任务</span><br>
<div class="block1">
	<p>如果你的 Linux 主机是作为 24 小时全天、全年无休的服务器之用，那么你只要有 atd 与 crond 
	这两个服务来管理你的例行性工作排程即可。如果你的服务器并非 24 小时无间断的启动，那么你该如何进行例行性工作？
	举例来说，如果你每天晚上都要关机，等到白天才启动你的 Linux 主机时，由於 CentOS 默认的工作排程都在
	4:02am 每天进行，唔！如此一来不就一堆系统例行工作都没有人在做了！那可怎么办？此时就得要 anacron 这家伙了！<br><br></p>

	<hr><a name="anacron_what"></a><img src="../images/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">什么是 anacron</span><br>
	<div class="block2">
		<p>anacron 并不是用来取代 crontab 的，anacron 存在的目的就在於我们上头提到的，在处理非 
		24 小时一直启动的 Linux 系统的 crontab 的运行！所以 anacron 并不能指定何时运行某项任务，
		而是以天为单位或者是在启动后立刻进行 anacron 的动作，他会去侦测停机期间应该进行但是并没有进行的
		crontab 任务，并将该任务运行一遍后，anacron 就会自动停止了。</p>

		<p>由於 anacron 会以一天、七天、一个月为期去侦测系统未进行的 crontab 任务，因此对於某些特殊的使用环境非常有帮助。
		举例来说，如果你的 Linux 主机是放在公司给同仁使用的，因为周末假日大家都不在所以也没有必要开启，
		因此你的 Linux 是周末都会关机两天的。但是 crontab 大多在每天的凌晨以及周日的早上进行各项任务，
		偏偏你又关机了，此时系统很多 crontab 的任务就无法进行。 anacron 刚好可以解决这个问题！</p>

		<p>那么 anacron 又是怎么知道我们的系统啥时关机的呢？这就得要使用 anacron 读取的时间记录档 (timestamps) 了！
		anacron 会去分析现在的时间与时间记录档所记载的上次运行 anacron 的时间，两者比较后若发现有差异，
		那就是在某些时刻没有进行 crontab 罗！此时 anacron 就会开始运行未进行的 crontab 任务了！
		<span class="text_import2">所以 anacron 其实也是透过 crontab 
		来运行的！因此 anacron 运行的时间通常有两个，一个是系统启动期间运行，一个是写入 crontab 的排程中。</span>
		这样才能够在特定时间分析系统未进行的 crontab 工作嘛！了解乎！</p>
	</div>

	<hr><a name="anacron"></a><img src="../images/logo.png" alt="小标题的图示" width="24" align="middle" height="23"><span class="text_h2">anacron 与 /etc/anacrontab</span><br>
	<div class="block2">
		<p>anacron 其实是一支程序并非一个服务！这支程序在 CentOS 当中已经进入 crontab 的排程喔！
		不相信吗？你可以这样追踪看看：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">ll /etc/cron*/*ana*</span>
-rwxr-xr-x 1 root root 379 Mar 28  2007 /etc/cron.daily/0anacron
-rwxr-xr-x 1 root root 381 Mar 28  2007 /etc/cron.monthly/0anacron
-rwxr-xr-x 1 root root 380 Mar 28  2007 /etc/cron.weekly/0anacron
<span class="term_say"># 刚好是每天、每周、每月有排程的工作目录！查阅一下每天的任务</span>

[root@www ~]# <span class="term_command">cat /etc/cron.daily/0anacron</span>
if [ ! -e /var/run/anacron.pid ]; then
    anacron -u cron.daily
fi
<span class="term_say"># 所以其实也仅是运行 anacron -u 的命令！因此我们得来谈谈这支程序！</span>
</pre></td></tr></tbody></table>

		<p>基本上， anacron 的语法如下：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">anacron [-sfn] [job]..</span>
[root@www ~]# <span class="term_command">anacron -u [job]..</span>
<span class="term_say">选项与参数：
-s  ：开始一连续的运行各项工作 (job)，会依据时间记录档的数据判断是否进行；
-f  ：强制进行，而不去判断时间记录档的时间戳记；
-n  ：立刻进行未进行的任务，而不延迟 (delay) 等待时间；
-u  ：仅升级时间记录档的时间戳记，不进行任何工作。
job ：由 /etc/anacrontab 定义的各项工作名称。</span>
</pre></td></tr></tbody></table>

		<p>所以我们发现<span class="text_import2">其实 /etc/cron.daily/0anacron 
		仅进行时间戳记的升级，而没有进行任何 anacron 的动作</span>！
		在我们的 CentOS 中，anacron 的进行其实是在启动完成后才进行的一项工作任务，你也可以将 anacron 排入 crontab 
		的排程中。但是为了担心 anacron 误判时间参数，因此 /etc/cron.daily/ 里面的 anacron 才会在档名之前加个 0 
		(0anacron)，让 anacron 最先进行！就是为了让时间戳记先升级！以避免 anacron 误判 crontab 
		尚未进行任何工作的意思。</p>

		<p>接下来我们看一下 /etc/anacrontab 的内容好了：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">cat /etc/anacrontab</span>
SHELL=/bin/sh
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root

<u>1       65      cron.daily     run-parts /etc/cron.daily</u>
7       70      cron.weekly    run-parts /etc/cron.weekly
30      75      cron.monthly   run-parts /etc/cron.monthly
<span class="term_say">天数   延迟时间 工作名称定义   实际要进行的命令串
# 天数单位为天；延迟时间单位为分钟；工作名称定义可自订；
# 命令串则通常与 crontab 的配置相同！</span>

[root@www ~]# <span class="term_command">more /var/spool/anacron/*</span>
::::::::::::::
/var/spool/anacron/cron.daily
::::::::::::::
<u>20090315</u>
::::::::::::::
/var/spool/anacron/cron.monthly
::::::::::::::
20090301
::::::::::::::
/var/spool/anacron/cron.weekly
::::::::::::::
20090315
<span class="term_say"># 上面则是三个工作名称的时间记录档以及记录的时间戳记</span>
</pre></td></tr></tbody></table>

		<p>由於 /etc/cron.daily 内的任务比较多，因此我们使用每天进行的任务来解释一下 anacron 的运行情况好了。
		anacron 若下达『 <span class="text_import2">anacron -s cron.daily</span> 』时，他会这样运行的：</p>

		<ol class="text_import2">
		<li>由 /etc/anacrontab 分析到 cron.daily 这项工作名称的天数为 1 天；</li>
		<li>由 /var/spool/anacron/cron.daily 取出最近一次运行 anacron 的时间戳记；</li>
		<li>由上个步骤与目前的时间比较，若差异天数为 1 天以上 (含 1 天)，就准备进行命令；</li>
		<li>若准备进行命令，根据 /etc/anacrontab 的配置，将延迟 65 分钟</li>
		<li>延迟时间过后，开始运行后续命令，亦即『 run-parts /etc/cron.daily 』这串命令；</li>
		<li>运行完毕后， anacron 程序结束。</li>
		</ol>

		<p>所以说，时间戳记是非常重要的！anacron 是透过该记录与目前的时间差异，了解到是否应该要进行某项任务的工作！
		举例来说，如果我的主机在 2009/03/15(星期天) 18:00 关机，然后在 2009/03/16(星期一) 8:00 启动，由於我的 
		crontab 是在早上 04:00 左右进行各项任务，由於该时刻系统是关机的，因此时间戳记依旧为 20090315 (旧的时间)，
		但是目前时间已经是 20090316 (新的时间)，因此 <span class="text_import2">run-parts /etc/cron.daily 
		就会在启动过 65 分钟后开始运行了</span>。</p>

		<p>所以罗， anacron 并不需要额外的配置，使用默认值即可！只是我们的 CentOS 只有在启动时才会运行
		anacron 就是了。如果要确定 anacron 是否启动时会主动的运行，你可以下达下列命令：</p>

<table class="term"><tbody><tr><td class="term"><pre>[root@www ~]# <span class="term_command">chkconfig --list anacron</span>
anacron      0:off   1:off   2:on    3:on    4:on    5:on    6:off
<span class="term_say"># 详细的 chkconfig 说明我们会在后续章节提到，注意看 3, 5
# 的项目，都是 on ！那就是有启动啦！启动时才会运行的意思！</span>
</pre></td></tr></tbody></table>

		<p>现在你知道<span class="text_import2">为什么隔了一阵子才将 CentOS 启动，启动过后约 1 
		小时左右系统会有一小段时间的忙碌！而且硬盘会跑个不停！那就是因为 anacron 正在运行过去 crontab 
		未进行的各项工作排程啦！</span>这样对 anacron 有没有概念了呢？ ^_^</p>
	</div>
</div>
<hr />
    </td>
    <td style="width: 16px; font-size: 6px;">　</td></tr>
<tr><td style="width: 16px; height: 16px;">　</td>
    <td style="width: 866px; height: 16px;">　</td>
    <td style="width: 16px; height: 16px;">　</body></html>